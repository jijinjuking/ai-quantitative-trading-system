# ğŸšª API Gateway Service

ä¼ä¸šçº§é‡åŒ–äº¤æ˜“å¹³å°çš„APIç½‘å…³æœåŠ¡ï¼Œæä¾›ç»Ÿä¸€çš„å…¥å£ç‚¹ã€è®¤è¯ã€é™æµã€è´Ÿè½½å‡è¡¡å’ŒæœåŠ¡ä»£ç†åŠŸèƒ½ã€‚

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### ğŸ” è®¤è¯ä¸æˆæƒ
- JWTä»¤ç‰ŒéªŒè¯
- åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶(RBAC)
- æƒé™æ£€æŸ¥ä¸­é—´ä»¶
- ä»¤ç‰Œåˆ·æ–°æœºåˆ¶

### ğŸš¦ æµé‡æ§åˆ¶
- æ»‘åŠ¨çª—å£é™æµç®—æ³•
- IPå’Œç”¨æˆ·çº§åˆ«é™æµ
- ç™½åå•æœºåˆ¶
- ç†”æ–­å™¨ä¿æŠ¤

### ğŸ”„ æœåŠ¡ä»£ç†
- æ™ºèƒ½è·¯ç”±è½¬å‘
- è´Ÿè½½å‡è¡¡
- å¥åº·æ£€æŸ¥
- æ•…éšœè½¬ç§»

### ğŸ“Š ç›‘æ§ä¸æŒ‡æ ‡
- PrometheusæŒ‡æ ‡æ”¶é›†
- è¯·æ±‚è¿½è¸ª
- æ€§èƒ½ç›‘æ§
- å¥åº·æ£€æŸ¥ç«¯ç‚¹

## ğŸš€ å¿«é€Ÿå¯åŠ¨

### 1. ç¯å¢ƒå‡†å¤‡
```bash
# å¤åˆ¶ç¯å¢ƒå˜é‡é…ç½®
cp .env.example .env

# ç¼–è¾‘é…ç½®æ–‡ä»¶
vim .env
```

### 2. å¯åŠ¨Redis
```bash
# ä½¿ç”¨Dockerå¯åŠ¨Redis
docker run -d --name redis -p 6379:6379 redis:7-alpine
```

### 3. è¿è¡Œç½‘å…³
```bash
# å¼€å‘æ¨¡å¼
cargo run

# ç”Ÿäº§æ¨¡å¼
cargo run --release
```

## ğŸ“¡ APIç«¯ç‚¹

### å¥åº·æ£€æŸ¥
```
GET /health
```

### æŒ‡æ ‡ç›‘æ§
```
GET /metrics
```

### è®¤è¯æ¥å£
```
POST /api/v1/auth/login
POST /api/v1/auth/logout
POST /api/v1/auth/refresh
```

### æœåŠ¡ä»£ç†
```
GET|POST|PUT|DELETE /api/v1/{service}/*path
```

### ç®¡ç†æ¥å£
```
GET /admin/services
GET /admin/circuit-breakers
GET /admin/rate-limits
```

## âš™ï¸ é…ç½®è¯´æ˜

### æœåŠ¡å™¨é…ç½®
- `GATEWAY_HOST`: ç›‘å¬åœ°å€ (é»˜è®¤: 0.0.0.0)
- `GATEWAY_PORT`: ç›‘å¬ç«¯å£ (é»˜è®¤: 8080)

### è®¤è¯é…ç½®
- `JWT_SECRET`: JWTç­¾åå¯†é’¥ (å¿…é¡»è®¾ç½®)
- `JWT_EXPIRY`: ä»¤ç‰Œè¿‡æœŸæ—¶é—´ (é»˜è®¤: 3600ç§’)

### Redisé…ç½®
- `REDIS_URL`: Redisè¿æ¥åœ°å€ (é»˜è®¤: redis://localhost:6379)

### é™æµé…ç½®
- `RATE_LIMIT_ENABLED`: æ˜¯å¦å¯ç”¨é™æµ (é»˜è®¤: true)
- `RATE_LIMIT_REQUESTS_PER_MINUTE`: æ¯åˆ†é’Ÿè¯·æ±‚æ•° (é»˜è®¤: 100)
- `RATE_LIMIT_BURST_SIZE`: çªå‘è¯·æ±‚æ•° (é»˜è®¤: 20)

## ğŸ—ï¸ æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client App    â”‚â”€â”€â”€â–¶â”‚   API Gateway   â”‚â”€â”€â”€â–¶â”‚  Microservices  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚      Redis      â”‚
                       â”‚   (Rate Limit)  â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¸­é—´ä»¶é“¾
1. **Request ID**: ç”Ÿæˆå”¯ä¸€è¯·æ±‚æ ‡è¯†
2. **CORS**: è·¨åŸŸèµ„æºå…±äº«å¤„ç†
3. **Rate Limit**: æµé‡æ§åˆ¶å’Œé™æµ
4. **Auth**: èº«ä»½è®¤è¯å’Œæˆæƒ
5. **Metrics**: æŒ‡æ ‡æ”¶é›†å’Œç›‘æ§
6. **Proxy**: æœåŠ¡ä»£ç†å’Œè½¬å‘

### æœåŠ¡å‘ç°
- é™æ€é…ç½®æœåŠ¡ç«¯ç‚¹
- å¥åº·æ£€æŸ¥æœºåˆ¶
- è‡ªåŠ¨æ•…éšœè½¬ç§»
- è´Ÿè½½å‡è¡¡ç®—æ³•

## ğŸ”§ å¼€å‘æŒ‡å—

### æ·»åŠ æ–°çš„ä¸­é—´ä»¶
```rust
// 1. åœ¨ middleware/ ç›®å½•åˆ›å»ºæ–°æ–‡ä»¶
// 2. å®ç°ä¸­é—´ä»¶å‡½æ•°
pub async fn my_middleware(
    request: Request,
    next: Next,
) -> Response {
    // ä¸­é—´ä»¶é€»è¾‘
    next.run(request).await
}

// 3. åœ¨ main.rs ä¸­æ³¨å†Œ
.layer(axum::middleware::from_fn(my_middleware))
```

### æ·»åŠ æ–°çš„è·¯ç”±
```rust
// 1. åœ¨ routes/ ç›®å½•åˆ›å»ºå¤„ç†å™¨
pub async fn my_handler(
    State(state): State<AppState>,
) -> Result<Json<ApiResponse<MyData>>, StatusCode> {
    // å¤„ç†é€»è¾‘
}

// 2. åœ¨ routes/mod.rs ä¸­æ³¨å†Œ
.route("/api/v1/my-endpoint", get(my_handler))
```

## ğŸ“Š ç›‘æ§æŒ‡æ ‡

### HTTPæŒ‡æ ‡
- `http_requests_total`: æ€»è¯·æ±‚æ•°
- `http_request_duration_seconds`: è¯·æ±‚è€—æ—¶
- `http_response_size_bytes`: å“åº”å¤§å°

### ä¸šåŠ¡æŒ‡æ ‡
- `auth_requests_total`: è®¤è¯è¯·æ±‚æ•°
- `rate_limit_requests_total`: é™æµè¯·æ±‚æ•°
- `circuit_breaker_events_total`: ç†”æ–­å™¨äº‹ä»¶æ•°

### ç³»ç»ŸæŒ‡æ ‡
- `memory_usage_bytes`: å†…å­˜ä½¿ç”¨é‡
- `cpu_usage_percent`: CPUä½¿ç”¨ç‡
- `active_connections`: æ´»è·ƒè¿æ¥æ•°

## ğŸ”’ å®‰å…¨ç‰¹æ€§

### è®¤è¯å®‰å…¨
- JWTä»¤ç‰ŒåŠ å¯†å­˜å‚¨
- ä»¤ç‰Œè¿‡æœŸè‡ªåŠ¨åˆ·æ–°
- é˜²é‡æ”¾æ”»å‡»ä¿æŠ¤

### ç½‘ç»œå®‰å…¨
- HTTPSå¼ºåˆ¶åŠ å¯†
- CORSç­–ç•¥æ§åˆ¶
- IPç™½åå•æœºåˆ¶

### æ•°æ®å®‰å…¨
- æ•æ„Ÿä¿¡æ¯è„±æ•
- è¯·æ±‚æ—¥å¿—è¿‡æ»¤
- é”™è¯¯ä¿¡æ¯éšè—

## ğŸš¨ æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

1. **Redisè¿æ¥å¤±è´¥**
   ```bash
   # æ£€æŸ¥RedisæœåŠ¡çŠ¶æ€
   docker ps | grep redis
   
   # æ£€æŸ¥ç½‘ç»œè¿æ¥
   telnet localhost 6379
   ```

2. **JWTéªŒè¯å¤±è´¥**
   ```bash
   # æ£€æŸ¥JWTå¯†é’¥é…ç½®
   echo $JWT_SECRET
   
   # éªŒè¯ä»¤ç‰Œæ ¼å¼
   curl -H "Authorization: Bearer <token>" /api/v1/protected
   ```

3. **æœåŠ¡ä»£ç†å¤±è´¥**
   ```bash
   # æ£€æŸ¥ä¸‹æ¸¸æœåŠ¡çŠ¶æ€
   curl http://localhost:8081/health
   
   # æŸ¥çœ‹ç†”æ–­å™¨çŠ¶æ€
   curl http://localhost:8080/admin/circuit-breakers
   ```

### æ—¥å¿—åˆ†æ
```bash
# æŸ¥çœ‹å®æ—¶æ—¥å¿—
tail -f logs/gateway.log

# è¿‡æ»¤é”™è¯¯æ—¥å¿—
grep "ERROR" logs/gateway.log

# åˆ†æè¯·æ±‚ç»Ÿè®¡
grep "HTTP request completed" logs/gateway.log | wc -l
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### è¿æ¥æ± ä¼˜åŒ–
- Redisè¿æ¥æ± å¤§å°è°ƒä¼˜
- HTTPå®¢æˆ·ç«¯è¿æ¥å¤ç”¨
- æ•°æ®åº“è¿æ¥æ± é…ç½®

### ç¼“å­˜ç­–ç•¥
- æœåŠ¡å‘ç°ç»“æœç¼“å­˜
- è®¤è¯ç»“æœç¼“å­˜
- é…ç½®ä¿¡æ¯ç¼“å­˜

### å¼‚æ­¥å¤„ç†
- éé˜»å¡I/Oæ“ä½œ
- å¼‚æ­¥ä¸­é—´ä»¶é“¾
- å¹¶å‘è¯·æ±‚å¤„ç†

---

**ç‰ˆæœ¬**: v1.0.0  
**ç»´æŠ¤è€…**: é‡åŒ–äº¤æ˜“å¹³å°å¼€å‘å›¢é˜Ÿ  
**æ›´æ–°æ—¶é—´**: 2025-12-15